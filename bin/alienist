#!/usr/bin/env ruby

require 'optparse'
require 'alienist/parser'
require 'alienist/reader'
require 'alienist/snapshot/memory_snapshot'
require 'alienist/snapshot/sequel_snapshot'

debug = 0

# FIXME: Use lambda to stuff require into it so we don't need world loaded.
BACKENDS = {
  'memory' => Alienist::Snapshot::MemorySnapshot,
  'sequel' => Alienist::Snapshot::SequelSnapshot,
}

backend = BACKENDS['sequel']

opts = OptionParser.new do |opts|
  opts.banner = "Usage: alienist [options] dump_file"
  opts.on("-d", "--debug value", "turn on debugging") do |v|
    debug = v.to_i
  end
  opts.on("-b", "--backend name", "Backend: #{BACKENDS.keys.join(', ')}") do |v|
    backend = BACKENDS[v]
    opts.usage "Valid backends: #{BACKENDS.keys.join(', ')}" unless backend
  end
end
opts.parse!(ARGV)

filename = ARGV.shift

abort "No filename provided" unless filename

File.open(filename, "rb") do |io|
  reader = Alienist::Reader.new(io, debug)
  dump = Alienist::Parser.new reader, backend.new, debug
  dump.parse
end
